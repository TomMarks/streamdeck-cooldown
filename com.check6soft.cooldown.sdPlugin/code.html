<!DOCTYPE HTML>
<html>

<head>
	<title>com.check6soft.cooldown</title>
    <meta charset="utf-8" />
</head>

<body>
	
    <script>
    	const UPDATE_INTERVAL_MS = 1000;
		const TIMEOUT_MS = 5000;
		const COOLDOWN_INTERVALS = Math.floor(TIMEOUT_MS / UPDATE_INTERVAL_MS);
		const COOLDOWN_COUNTER_KEY = "cooldownCounter";
		
    	var websocket = null;
    	var pluginUUID = null;
    	
    	var DestinationEnum = Object.freeze({"HARDWARE_AND_SOFTWARE":0, "HARDWARE_ONLY":1, "SOFTWARE_ONLY":2})
    	
        var timer;
        
    	var cooldownAction = {		
			
			type : "com.check6soft.cooldown.action",
			timer: null,
			timeoutTimer: null,

			
			getStoreKey : function(store, key, defaultValue) {
				var result = defaultValue;
				if(store != null && store.hasOwnProperty(key)){
					result = store[key];
				}
				return result;
			},
			
			setStoreKey : function(store, key, value) {
				if (store == null) {
					store = {};
				}

				store[key] = value;
				return store;
			},

			finalize : function() {
				if (this.timer != null) {
					clearTimeout(this.timer);
					this.timer = null;
				}
				
				if (this.timeoutTimer != null) {
					clearTimeout(this.timeoutTimer);
					this.timeoutTimer = null;
				}
			},

			onKeyDown : function(context, settings, coordinates, userDesiredState) {
				if (this.timer == null) {
					var updatedSettings = this.setStoreKey(settings, COOLDOWN_COUNTER_KEY, COOLDOWN_INTERVALS);
					
					// Initialize the title
					this.SetTitle(context, updatedSettings[COOLDOWN_COUNTER_KEY]);

					// Start the update timer- some grain of the timeout value
					this.timeoutTimer = setInterval(function () {
						var buttonCooldown = this.getStoreKey(updatedSettings, COOLDOWN_COUNTER_KEY, 0);
						buttonCooldown > 0 ? buttonCooldown-- : buttonCooldown = 0;

						updatedSettings = this.setStoreKey(updatedSettings, COOLDOWN_COUNTER_KEY, buttonCooldown);
						
						this.SetSettings(context, updatedSettings);
						this.SetTitle(context, buttonCooldown);
					}.bind(this), UPDATE_INTERVAL_MS);	

				
					this.timer = setTimeout(function () {
						var updatedSettings = this.setStoreKey(null, COOLDOWN_COUNTER_KEY, 0);
					
						this.SetSettings(context, updatedSettings);
						this.SetTitle(context, "");
						
						// Cleanup
						this.finalize();
					}.bind(this), TIMEOUT_MS);
				}
			},
			
			onKeyUp : function(context, settings, coordinates, userDesiredState) {
				
			},
			
			onWillAppear : function(context, settings, coordinates) {
				// Initialize the title
				settings = this.setStoreKey(settings, COOLDOWN_COUNTER_KEY, 0);
				this.SetTitle(context, "");
				this.SetSettings(context, settings);
			},
			
			SetTitle : function(context, text) {
				var json = {
					"event": "setTitle",
					"context": context,
					"payload": {
						"title": "" + text,
						"target": DestinationEnum.HARDWARE_AND_SOFTWARE
					}
				};
			
				websocket.send(JSON.stringify(json));
			 },
			 
			 SetSettings : function(context, settings) {
				var json = {
					"event": "setSettings",
					"context": context,
					"payload": settings
				};
			
				websocket.send(JSON.stringify(json));
			 }
		};
    	
        function connectElgatoStreamDeckSocket(inPort, inPluginUUID, inRegisterEvent, inInfo)
         {
         	pluginUUID = inPluginUUID
         	
			// Open the web socket
			websocket = new WebSocket("ws://127.0.0.1:" + inPort);
			cooldownAction.websocket = websocket;
			
			function registerPlugin(inPluginUUID)
			 {
				var json = {
					"event": inRegisterEvent,
					"uuid": inPluginUUID
				};
			
				websocket.send(JSON.stringify(json));
			 };
			
			websocket.onopen = function()
			{
				// WebSocket is connected, send message
				registerPlugin(pluginUUID);
			};

			websocket.onmessage = function (evt)
			{ 
				// Received message from Stream Deck
				var jsonObj = JSON.parse(evt.data);
				var event = jsonObj['event'];
				var action = jsonObj['action'];
				var context = jsonObj['context'];
				
				if(event == "keyDown")
				{
					var jsonPayload = jsonObj['payload'];
					var settings = jsonPayload['settings'];
					var coordinates = jsonPayload['coordinates'];
					var userDesiredState = jsonPayload['userDesiredState'];
					cooldownAction.onKeyDown(context, settings, coordinates, userDesiredState);
				}
				else if(event == "keyUp")
				{
					var jsonPayload = jsonObj['payload'];
					var settings = jsonPayload['settings'];
					var coordinates = jsonPayload['coordinates'];
					var userDesiredState = jsonPayload['userDesiredState'];
					cooldownAction.onKeyUp(context, settings, coordinates, userDesiredState);
				}
				else if(event == "willAppear")
				{
					var jsonPayload = jsonObj['payload'];
					var settings = jsonPayload['settings'];
					var coordinates = jsonPayload['coordinates'];
					cooldownAction.onWillAppear(context, settings, coordinates);
				}
			};

			websocket.onclose = function()
			{ 
				// Websocket is closed
				cooldownAction.finalize();
			};
         };
         
         
         
         
    </script>

</body>

</html>
